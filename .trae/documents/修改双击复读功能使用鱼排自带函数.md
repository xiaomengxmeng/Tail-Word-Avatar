# 修改双击复读功能使用鱼排自带函数

## 核心任务

将 `button_manager.js` 中的双击复读功能从自定义 HTML 转 Markdown 然后发送，修改为使用鱼排自带的 `ChatRoom.repeat` 函数进行复读。

## 实现步骤

### 1. 替换双击事件处理逻辑

将双击事件处理函数中的内容替换为：

* 提取消息信息

* 检查消息 ID 是否以 "chatroom" 开头

* 如果是，提取 chatId

* 调用 `ChatRoom.repeat(chatId)` 进行复读

* 显示成功提示

### 2. 移除不必要的函数

由于不再需要自定义的 HTML 转 Markdown 功能，可以移除相关函数：

* `htmlToMarkdownQuote` 函数

## 代码实现

### 1. 修改双击事件处理函数

```javascript
// 双击消息内容复读功能
document.addEventListener('dblclick', function(event) {
    // 检查是否双击了消息内容区域
    const chatContent = event.target.closest('.chats__content');
    if (!chatContent) return;
    
    // 阻止默认行为
    event.preventDefault();
    event.stopPropagation();
    
    // 提取消息信息
    const messageInfo = extractMessageInfo(chatContent);
    if (!messageInfo || !messageInfo.username || !messageInfo.messageId) {
        console.error('无法提取消息信息');
        showNotification('无法提取消息信息', 'error');
        return;
    }
    
    // 检查消息 ID 是否以 "chatroom" 开头
    if (messageInfo.messageId.startsWith('chatroom')) {
        const chatId = messageInfo.messageId.slice(8);
        // 使用鱼排自带的复读函数
        ChatRoom.repeat(chatId);
        showNotification('消息已复读', 'success');
    } else {
        showNotification('无法复读此消息', 'error');
    }
});
```

### 保留

&#x20;`htmlToMarkdownQuote` 函数，因为不再需要自定义的 HTML 转 Markdown 功能。

## 技术要点

1. **使用鱼排自带函数**：`ChatRoom.repeat(chatId)`
2. **正确提取 chatId**：从消息 ID 中移除 "chatroom" 前缀
3. **消息 ID 验证**：确保消息 ID 以 "chatroom" 开头
4. **错误处理**：添加适当的错误提示
5. <br />

## 预期结果

* 双击消息内容时，使用鱼排自带的复读功能

* 支持各种类型的消息，包括图片、链接、引用等

* 与鱼排系统无缝集成

  <br />

